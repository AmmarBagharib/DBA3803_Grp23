---
title: "Group 23 Cumulative Return Plot"
date: "9/11/2022"
output: html_document
---

#loading packages
```{r}
library(dplyr)
library(glmnet)
library(lubridate)
library(ggplot2)
```

#loading the File
```{r}
data <- na.omit(read.csv('NEW_48_Industry_Portfolios_Daily.csv', skip = 9, na.strings = "-99.99"))

colnames(data)[1] <- 'Dates' #rename dates column
```

#Cummulative Return Code
```{r}
N_industry <- c(2:49)
columns <- colnames(data)[c(1, N_industry)]

w_ew <- matrix(1/length(N_industry), nrow = length(N_industry), ncol = 1) # Get the equally weighted matrix

# N identity matrix as identified in the mathematical equation
N <- rbind(diag(length(N_industry) - 1), matrix(-1, ncol = length(N_industry) - 1)) 

# Choosing start and end dates
end_row <- which(data$Dates == "20220103") 
start_row <- which(data$Dates =="20120103")

#convert dates column into date format
data <- data %>% mutate(Dates = ymd(as.character(Dates)))

#slice data based on start and end dates
data1 <- data[columns][start_row:end_row,]

# Scale the data such that the data is demean where the sample mean of each asset return is 0
# by specifying center=T and scale=F, we aim to subtract the mean from each individual return but NOT dividing by the standard deviation.
demean <- scale(data1[, c(2:length(columns))], center=T, scale = F) 

y <- demean %*% w_ew # Matrix multiplication of RWew
x <- demean %*% N # Matrix multiplication of RN
lasso <- cv.glmnet(x, y, alpha = 1, standardise = F, intercept = F) 
ridge <- cv.glmnet(x, y, alpha = 0, standardise = F, intercept = F) 
```

#deriving beta and weights
```{r}
#applying weights of coefficients.
lasso_beta <- t(matrix(coef(lasso, s = "lambda.min")))[-1] #or should we use lambda.1se?
ridge_beta <- t(matrix(coef(ridge, s = "lambda.min")))[-1]

lasso_weights <- w_ew - N %*% lasso_beta
ridge_weights <- w_ew - N %*% ridge_beta

```

#function to extract daily returns
```{r}
daily_returns <- function(weights, df){
  # weights = lasso_weights
  # df = data1
  #function to return vector of daily returns
  #initialise vector of returns
  returns <- c()
  #for loop to generate returns from model
  for (i in 1:nrow(df)){
    #sumproduct weights and individual returns
    day_return <- crossprod(as.vector(weights), as.numeric(as.vector(df[i, 2:ncol(df)])))
    #append weighted return
    returns <- append(returns, day_return)
  }
  return (returns)
}
```

#daily returns for lasso, ridge, ew
```{r}
lasso_daily_returns <- daily_returns(lasso_weights, data1)
ridge_daily_returns <- daily_returns(ridge_weights, data1)
ew_daily_returns <- daily_returns(w_ew, data1)

#initialise vector of cumulative returns with initial investment of $10
cum_lasso_returns_vector <- c(10 * (1 + lasso_daily_returns[1] / 100))
cum_ridge_returns_vector <- c(10 * (1 + ridge_daily_returns[1] / 100))
cum_ew_returns_vector <- c(10 * (1 + ew_daily_returns[1] / 100))

```

#function to return vector of cumulative returns
```{r}
cum_return <- function(df, return_vector, cum_return_vector){
  #function returns cum return for initial investment of $10
  #inputs 'return vector' is the vector of daily returns
  # df = data1
  # return_vector = lasso_daily_returns
  # cum_return_vector = cum_lasso_returns_vector
  for (i in 2:nrow(df)){
    #i = 1
    # return of that day
    return <- 1 + return_vector[i] / 100
    # new cum return based on previous day daily return
    new_cum_r <- cum_return_vector[i - 1] * return
    # append new cum return
    cum_return_vector <- append(cum_return_vector, new_cum_r)
  }
  return (cum_return_vector)
}
```

#create dataframe consisting of respective cum returns
```{r}
lasso_cum_return <- cum_return(data1, lasso_daily_returns, cum_lasso_returns_vector) #lasso regularised cum return
ridge_cum_return <- cum_return(data1, ridge_daily_returns, cum_ridge_returns_vector) #ridge regularised cum return
ew_cum_return <- cum_return(data1, ew_daily_returns, cum_ew_returns_vector) #equally weighted cum return


#create returns dataframe
returns_df <- data1 %>% 
  select(Dates) %>%
  mutate(Dates = ymd(Dates),
         Ridge_Cum_Return = ridge_cum_return,
         Lasso_Cum_Return = lasso_cum_return,
         EW_Cum_Return = ew_cum_return)
```

##plotting graph
```{r}
ggplot(returns_df, aes(x = Dates)) +
  geom_line(aes(y = Ridge_Cum_Return, color = "Ridge")) +
  geom_line(aes(y = Lasso_Cum_Return, color = "LASSO")) +
  geom_line(aes(y = EW_Cum_Return, color = "Equally-Weighted")) +
  scale_color_manual(name = "Legend", values = c("Ridge" = "blue", 
                                                 "LASSO" = "darkred", 
                                                 "Equally-Weighted" = "black")) +
  labs(title = "Cumulative Return", subtitle = "based on $10 initial investment", y = '', x = "Dates") +
  theme(plot.title = element_text(face="bold"),
        plot.subtitle = element_text(face = "italic"))
```

